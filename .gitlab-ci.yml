cache:
  key: "$CI_COMMIT_REF_SLUG"
  paths:
    - deps/

stages:
  - build_deps
  - build
  - test
  - build_rpms
  - test_install
  - deploy

before_script:
  - yum install -y openldap-devel.x86_64
  - export VERSION=$(grep -m 1 'Version:' ./build/cdcm.spec | cut -d ' ' -f 5)
  - export REPORT_FNAME=results.$(date +%d-%m-%Y-%H:%M:%S).xml
    
after_script:
  - echo "After script section"

build_deps:
  stage: build_deps
  script:
    - cd build
    - scl enable devtoolset-8 'make deps'
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - deps/
    policy: pull-push
  tags:
    - cdcm

build:
  stage: build
  variables:
    DEPS_DIR: $CI_PROJECT_DIR/deps
  script:
    - scl enable devtoolset-8 bash
    - mkdir -p build_cdcm
    - cd build_cdcm
    - scl enable devtoolset-8 "cmake3 .."
    - scl enable devtoolset-8 "make -j4"
    - scl enable devtoolset-8 "make install"
  artifacts:
    paths:
      - build_cdcm/
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - deps/
    policy: pull
  tags: 
    - cdcm

test:
  stage: test
  script:
    - cd build_cdcm/src/tests/
    - echo "one two ..."
    - echo $REPORT_FNAME
    - ./tests_run --log_sink=$REPORT_FNAME --log_format=JUNIT --log_level=all --report_level=no -- --assets_path "$PWD/assets"
    - ls
    - ls -la
    - pwd
#  artifacts:
#    paths:
#      - build_cdcm/src/tests/$REPORT_FNAME
#    reports:
#      junit: build_cdcm/src/tests/$REPORT_FNAME
  tags:
    - cdcm

build_rpms:
  stage: build_rpms
  script:
    - cd build
    - rpmbuild -bb cdcm.spec
    - rpmbuild -bb samba-libs.spec
    - rpmbuild -bb tw-cdcm.spec
  artifacts:
    paths:
      - build/RPMS/x86_64/
  cache:
    key: "$CI_COMMIT_REF_SLUG"
    paths:
      - deps/
    policy: pull
  tags:
    - cdcm

test_install:
  stage: test_install
  tags:
    - cdcm-centos7
  script:
    - echo "will install rpm's and test"
    - cd build
    - yum localinstall -y RPMS/x86_64/*.rpm

deploy_release:
  stage: deploy
  script:
    - cd build
    - python nexus_deploy.py -a cdcm -v $VERSION -r release RPMS/x86_64/*.rpm
  only:
    - tags
  tags:
    - cdcm

deploy_snapshot:
  stage: deploy
  script:
    - cd build
    - python nexus_deploy.py -a cdcm -b $CI_COMMIT_BRANCH -v $VERSION RPMS/x86_64/*.rpm
  only:
    - branches
  tags:
    - cdcm
